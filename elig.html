<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Eligibility Checker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Main styles moved to tables.css -->
  <link rel="stylesheet" href="tables.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="elig.js"></script>
</head>
<body>
  <div class="app">
    <div class="app-header">
      <!-- header area is intentionally minimal -->
    </div>

    <div class="app-content">
      <aside class="sidebar">
        <h1 class="page-title">Eligibility Checker</h1>

        <!-- Explanation Box -->
        <div id="explanation" class="mb-3">
          <b>Welcome!</b> This is a simple tool for checking patient eligibility.
          <ul class="mb-0 mt-2">
            <li><b>1.</b> Upload your patient report (Clinicpro, Odoo, or InstaHMS).</li>
            <li><b>2.</b> Upload the Eligibility XLSX file.</li>
            <li><b>3.</b> Click <b>Process</b> to check eligibility.</li>
            <li><b>4.</b> Click <b>Export Invalid Rows</b> to download patients not eligible.</li>
          </ul>
        </div>

        <form>
          <div class="file-upload-area mb-3">
            <div class="mb-3">
              <label for="reportFileInput" class="form-label">Upload Patient Report (Clinicpro, Odoo, or InstaHMS):</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-file-earmark-excel"></i></span>
                <input type="file" class="form-control" id="reportFileInput" multiple accept=".xls,.xlsx,.csv">
              </div>
            </div>
            <div class="mb-3">
              <label for="eligibilityFileInput" class="form-label">Upload Eligibility XLSX:</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-file-earmark-spreadsheet"></i></span>
                <input type="file" class="form-control" id="eligibilityFileInput" accept=".xlsx">
              </div>
            </div>
          </div>

          <!-- Daman/Thiqa Filter Toggle -->
          <div class="filter-toggle-area">
            <label class="form-check-label">
              <input class="form-check-input me-2" type="checkbox" id="filterDamanThiqa">
              Show only <b>Daman / Thiqa</b> claims
            </label>
            <span id="filterStatus" class="filter-status">OFF</span>
          </div>

          <div class="d-flex gap-2 mb-2 justify-content-start">
            <button type="button" id="processBtn" class="btn btn-primary" disabled>
              <i class="bi bi-play-fill"></i> Process
            </button>
            <button type="button" id="exportInvalidBtn" class="btn btn-secondary" disabled>
              <i class="bi bi-arrow-down-circle"></i> Export Invalid Rows
            </button>
          </div>
          <div id="uploadStatus" class="mt-2 text-primary fs-6"></div>
        </form>

        <div style="height:18px;"></div>
        <div style="font-size:0.9rem; color:#58616a;">
          Tip: Results appear on the right. If the table is long you can scroll it independently; a subtle fade will appear at the bottom to indicate more content.
        </div>
      </aside>

      <main class="main">
        <div class="results-header">
          <div class="results-title">Results</div>
          <div style="font-size:0.9rem; color:#6c757d;">Table output and export actions</div>
        </div>

        <!-- This is the scrollable area where generated table(s) will be placed -->
        <div id="results" aria-live="polite">
          <!-- Existing behavior: elig.js should populate this #results element with the generated table -->
          <div class="text-muted">No results yet. Upload files and click Process.</div>
          <div class="results-footer-space"></div>
        </div>

        <!-- Fade overlay shown only when #results can be scrolled down -->
        <div class="fade-overlay" id="resultsFade"></div>
      </main>
    </div>
  </div>

  <!-- Bootstrap Icons CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <script src="table_clipboard.js"></script>

  <script>
    // Show a bottom fade when the right-hand results area is scrollable and not at the bottom.
    (function () {
      const results = document.getElementById('results');
      const fade = document.getElementById('resultsFade');

      if (!results || !fade) return;

      function updateFade() {
        // If content taller than container, and not scrolled to bottom, show fade
        const canScroll = results.scrollHeight > results.clientHeight;
        const notAtBottom = results.scrollTop < (results.scrollHeight - results.clientHeight - 1);
        if (canScroll && notAtBottom) {
          fade.style.display = 'block';
          fade.style.opacity = '1';
        } else {
          fade.style.opacity = '0';
          // keep display:none after transition
          setTimeout(() => { if (fade.style.opacity === '0') fade.style.display = 'none'; }, 200);
        }
      }

      // Update when user scrolls and when window resizes
      results.addEventListener('scroll', updateFade, { passive: true });
      window.addEventListener('resize', updateFade);

      // Observe DOM changes inside results (so when elig.js inserts the table we update fade)
      const mo = new MutationObserver(() => {
        // small delay to allow layout to settle
        setTimeout(updateFade, 60);
      });
      mo.observe(results, { childList: true, subtree: true });

      // Initial check
      document.addEventListener('DOMContentLoaded', updateFade);
      // Also run shortly after load in case scripts populated the results before DOMContentLoaded
      setTimeout(updateFade, 120);
      
      // Expose helper for external scripts to call after they update results
      window.__elig_updateResultsFade = updateFade;
    })();
  </script>
</body>
</html>
